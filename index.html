

<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ICU PI Management</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;500;600;700&display=swap');
        body { font-family: 'Sarabun', sans-serif; }
    </style>
</head>
<body class="bg-gradient-to-br from-teal-50 to-cyan-100 min-h-screen">
    <div class="container mx-auto px-4 py-6">
        <!-- Header -->
        <div class="bg-white rounded-lg shadow-lg p-6 mb-6">
            <div class="flex items-center justify-center mb-4">
                <div class="flex flex-col items-center mr-4">
                    <div class="bg-gradient-to-br from-teal-500 to-teal-600 rounded-full p-4 shadow-lg">
                        <svg class="w-16 h-16" fill="none" viewBox="0 0 24 24">
                            <!-- First bandage - diagonal from top-left to bottom-right -->
                            <g transform="rotate(45 12 12)">
                                <rect x="2" y="9" width="20" height="6" rx="3" ry="3" fill="#F5DEB3" stroke="#D2B48C" stroke-width="0.4"/>
                                <!-- Adhesive texture dots -->
                                <circle cx="4" cy="10.5" r="0.2" fill="#D2B48C" opacity="0.6"/>
                                <circle cx="6" cy="10.5" r="0.2" fill="#D2B48C" opacity="0.6"/>
                                <circle cx="8" cy="10.5" r="0.2" fill="#D2B48C" opacity="0.6"/>
                                <circle cx="4" cy="12" r="0.2" fill="#D2B48C" opacity="0.6"/>
                                <circle cx="6" cy="12" r="0.2" fill="#D2B48C" opacity="0.6"/>
                                <circle cx="8" cy="12" r="0.2" fill="#D2B48C" opacity="0.6"/>
                                <circle cx="4" cy="13.5" r="0.2" fill="#D2B48C" opacity="0.6"/>
                                <circle cx="6" cy="13.5" r="0.2" fill="#D2B48C" opacity="0.6"/>
                                <circle cx="8" cy="13.5" r="0.2" fill="#D2B48C" opacity="0.6"/>
                                
                                <circle cx="16" cy="10.5" r="0.2" fill="#D2B48C" opacity="0.6"/>
                                <circle cx="18" cy="10.5" r="0.2" fill="#D2B48C" opacity="0.6"/>
                                <circle cx="20" cy="10.5" r="0.2" fill="#D2B48C" opacity="0.6"/>
                                <circle cx="16" cy="12" r="0.2" fill="#D2B48C" opacity="0.6"/>
                                <circle cx="18" cy="12" r="0.2" fill="#D2B48C" opacity="0.6"/>
                                <circle cx="20" cy="12" r="0.2" fill="#D2B48C" opacity="0.6"/>
                                <circle cx="16" cy="13.5" r="0.2" fill="#D2B48C" opacity="0.6"/>
                                <circle cx="18" cy="13.5" r="0.2" fill="#D2B48C" opacity="0.6"/>
                                <circle cx="20" cy="13.5" r="0.2" fill="#D2B48C" opacity="0.6"/>
                                
                                <!-- Center gauze pad -->
                                <rect x="9.5" y="10" width="5" height="4" rx="1" ry="1" fill="#FAEBD7" stroke="#D2B48C" stroke-width="0.3" opacity="0.9"/>
                            </g>
                            
                            <!-- Second bandage - diagonal from top-right to bottom-left -->
                            <g transform="rotate(-45 12 12)">
                                <rect x="2" y="9" width="20" height="6" rx="3" ry="3" fill="#F5DEB3" stroke="#D2B48C" stroke-width="0.4"/>
                                <!-- Adhesive texture dots -->
                                <circle cx="4" cy="10.5" r="0.2" fill="#D2B48C" opacity="0.6"/>
                                <circle cx="6" cy="10.5" r="0.2" fill="#D2B48C" opacity="0.6"/>
                                <circle cx="8" cy="10.5" r="0.2" fill="#D2B48C" opacity="0.6"/>
                                <circle cx="4" cy="12" r="0.2" fill="#D2B48C" opacity="0.6"/>
                                <circle cx="6" cy="12" r="0.2" fill="#D2B48C" opacity="0.6"/>
                                <circle cx="8" cy="12" r="0.2" fill="#D2B48C" opacity="0.6"/>
                                <circle cx="4" cy="13.5" r="0.2" fill="#D2B48C" opacity="0.6"/>
                                <circle cx="6" cy="13.5" r="0.2" fill="#D2B48C" opacity="0.6"/>
                                <circle cx="8" cy="13.5" r="0.2" fill="#D2B48C" opacity="0.6"/>
                                
                                <circle cx="16" cy="10.5" r="0.2" fill="#D2B48C" opacity="0.6"/>
                                <circle cx="18" cy="10.5" r="0.2" fill="#D2B48C" opacity="0.6"/>
                                <circle cx="20" cy="10.5" r="0.2" fill="#D2B48C" opacity="0.6"/>
                                <circle cx="16" cy="12" r="0.2" fill="#D2B48C" opacity="0.6"/>
                                <circle cx="18" cy="12" r="0.2" fill="#D2B48C" opacity="0.6"/>
                                <circle cx="20" cy="12" r="0.2" fill="#D2B48C" opacity="0.6"/>
                                <circle cx="16" cy="13.5" r="0.2" fill="#D2B48C" opacity="0.6"/>
                                <circle cx="18" cy="13.5" r="0.2" fill="#D2B48C" opacity="0.6"/>
                                <circle cx="20" cy="13.5" r="0.2" fill="#D2B48C" opacity="0.6"/>
                                
                                <!-- Center gauze pad -->
                                <rect x="9.5" y="10" width="5" height="4" rx="1" ry="1" fill="#FAEBD7" stroke="#D2B48C" stroke-width="0.3" opacity="0.9"/>
                            </g>
                            

                        </svg>
                    </div>
                </div>
                <div>
                    <h1 class="text-3xl font-bold text-gray-800">ICU PI Management</h1>
                    <p class="text-gray-600">Braden Score Assessment & Pressure Ulcer Management</p>
                </div>
            </div>
        </div>

        <!-- Assessment Form -->
        <div class="bg-white rounded-lg shadow-lg p-6 mb-6">
            <h2 class="text-xl font-semibold text-gray-800 mb-4 flex items-center">
                <svg class="w-6 h-6 mr-2 text-teal-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path>
                </svg>
                ข้อมูลผู้ป่วย
            </h2>
            <form id="assessmentForm" class="space-y-4">
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">HN</label>
                        <input type="text" id="hn" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">เตียงที่</label>
                        <select id="bedNumber" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                            <option value="">เลือกเตียง</option>
                            <option value="1">เตียง 1</option>
                            <option value="2">เตียง 2</option>
                            <option value="3">เตียง 3</option>
                            <option value="4">เตียง 4</option>
                            <option value="5">เตียง 5</option>
                            <option value="6">เตียง 6</option>
                            <option value="7">เตียง 7</option>
                            <option value="8">เตียง 8</option>
                            <option value="9">เตียง 9</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">อายุ</label>
                        <input type="number" id="age" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                    </div>
                </div>

                <!-- Admission Information -->
                <div class="bg-blue-50 rounded-lg p-4 mb-4 shadow-sm">
                    <h3 class="text-lg font-semibold text-gray-800 mb-3 flex items-center">
                        <svg class="w-5 h-5 mr-2 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3a2 2 0 012-2h4a2 2 0 012 2v4m-6 0V6a2 2 0 012-2h4a2 2 0 012 2v1m-6 0h8m-9 0a1 1 0 00-1 1v10a1 1 0 001 1h10a1 1 0 001-1V8a1 1 0 00-1-1H7z"></path>
                        </svg>
                        ข้อมูลการรับผู้ป่วย
                    </h3>
                    
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">วันที่รับใหม่/รับย้าย</label>
                            <input type="date" id="admissionDate" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">ประเภทการรับ</label>
                            <select id="admissionSource" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                                <option value="">เลือกประเภท</option>
                                <option value="new_admission">รับใหม่</option>
                                <option value="transfer">รับย้าย</option>
                                <option value="refer">รับ Refer</option>
                            </select>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">รายละเอียดเพิ่มเติม</label>
                            <input type="text" id="admissionDetails" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="เช่น หอผู้ป่วยศัลยกรรม, ICU 2">
                        </div>
                    </div>
                    
                    <div class="mt-3">
                        <label class="block text-sm font-medium text-gray-700 mb-1">สภาพแผลกดทับเมื่อรับ (ถ้ามี)</label>
                        <textarea id="admissionWoundStatus" rows="2" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="เช่น มีแผลกดทับ Stage 2 ที่ sacrum ขนาด 3x2 cm จากที่บ้าน"></textarea>
                    </div>
                </div>

                <!-- Braden Score Assessment -->
                <div class="bg-teal-50 rounded-lg p-4 mb-4 shadow-sm">
                    <h3 class="text-lg font-semibold text-gray-800 mb-3 flex items-center">
                        <svg class="w-5 h-5 mr-2 text-teal-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-3 7h3m-3 4h3m-6-4h.01M9 16h.01"></path>
                        </svg>
                        การประเมิน Braden Score
                    </h3>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">1. การรับรู้</label>
                            <select id="sensoryPerception" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" onchange="calculateBradenScore()">
                                <option value="">เลือก</option>
                                <option value="1">1 - ไม่รู้สึกตัว/ไม่ตอบสนอง</option>
                                <option value="2">2 - มี pain stimulate/ได้รับยาสลบ/sedative</option>
                                <option value="3">3 - สับสนสื่อสารไม่ได้ทุกครั้ง</option>
                                <option value="4">4 - ปกติ</option>
                            </select>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">2. การเปียกชุ่ม</label>
                            <select id="moisture" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" onchange="calculateBradenScore()">
                                <option value="">เลือก</option>
                                <option value="1">1 - เปียกชุ่มตลอดเวลา(เหงื่อ/ปัสสาวะ)</option>
                                <option value="2">2 - ผิวหนังเปียกชุ่มบ่อยครั้ง เปลี่ยนผ้าอย่างน้อย 1 ครั้ง/เวร</option>
                                <option value="3">3 - ผิวหนังเปียกชุ่มบางครั้ง เปลี่ยนผ้าอย่างน้อย 1 ครั้ง/วัน</option>
                                <option value="4">4 - ปกติ</option>
                            </select>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">3. การทำกิจกรรม</label>
                            <select id="activity" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" onchange="calculateBradenScore()">
                                <option value="">เลือก</option>
                                <option value="1">1 - อยู่บนเตียงตลอดเวลา/ดึง traction</option>
                                <option value="2">2 - ไม่สามารถเดินได้เอง</option>
                                <option value="3">3 - เดินได้ในระยะทางสั้นๆ</option>
                                <option value="4">4 - ปกติ</option>
                            </select>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">4. การเคลื่อนไหว</label>
                            <select id="mobility" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" onchange="calculateBradenScore()">
                                <option value="">เลือก</option>
                                <option value="1">1 - เปลี่ยนท่าเองไม่ได้</option>
                                <option value="2">2 - เปลี่ยนท่าเองได้น้อย/ไม่สามารถทำได้บ่อย</option>
                                <option value="3">3 - เปลี่ยนท่าเองได้บ่อย</option>
                                <option value="4">4 - ปกติ</option>
                            </select>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">5. ภาวะโภชนาการ</label>
                            <select id="nutrition" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" onchange="calculateBradenScore()">
                                <option value="">เลือก</option>
                                <option value="1">1 - NPO /กินได้ 1/3 ถาด</option>
                                <option value="2">2 - Feed ได้บ้าง/กินได้ 1/2 ถาด</option>
                                <option value="3">3 - Feed ได้หมด/กินได้มากกว่า 1/2ถาด</option>
                                <option value="4">4 - ปกติ</option>
                            </select>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">6. การเสียดสี</label>
                            <select id="friction" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" onchange="calculateBradenScore()">
                                <option value="">เลือก</option>
                                <option value="1">1 - เคลื่อนไหวเองไม่ได้/ข้อกล้ามเนื้อหดเกร็ง ดึง traction</option>
                                <option value="2">2 - ทรงตัวได้เมื่ออยู่บนเตียงหรือเก้าอี้ แต่บางครั้งอาจลื่นไถลลงมา</option>
                                <option value="3">3 - ไม่มีปัญหา</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="mt-4 p-3 bg-white rounded-lg border-2 border-teal-200 shadow-sm">
                        <div class="flex items-center justify-between">
                            <span class="text-lg font-semibold text-gray-800">คะแนน Braden Score รวม:</span>
                            <span id="totalBradenScore" class="text-2xl font-bold text-teal-600">0</span>
                        </div>
                        <div id="riskLevel" class="text-sm mt-1 font-medium"></div>
                    </div>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">สถานะแผลกดทับ</label>
                        <select id="ulcerStatus" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                            <option value="none">ไม่มีแผลกดทับ</option>
                            <option value="stage1">Stage 1</option>
                            <option value="stage2">Stage 2</option>
                            <option value="stage3">Stage 3</option>
                            <option value="stage4">Stage 4</option>
                            <option value="unstageable">Unstageable</option>
                            <option value="dtpi">Deep Tissue Pressure Injury</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">ตำแหน่งแผล (ถ้ามี)</label>
                        <input type="text" id="ulcerLocation" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="เช่น sacrum, heel">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">วันที่บันทึก</label>
                        <input type="date" id="recordDate" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                    </div>
                </div>

                <!-- Hidden Braden Score field for form submission -->
                <input type="hidden" id="bradenScore" required>



                <div class="flex justify-end space-x-3">
                    <button type="button" id="clearAssessment" class="px-4 py-2 bg-yellow-500 text-white rounded-md hover:bg-yellow-600 transition-colors">ล้างการประเมิน</button>
                    <button type="button" id="clearForm" class="px-4 py-2 bg-gray-500 text-white rounded-md hover:bg-gray-600 transition-colors">ล้างทั้งหมด</button>
                    <button type="submit" class="px-6 py-2 bg-teal-600 text-white rounded-md hover:bg-teal-700 transition-colors shadow-md">บันทึกข้อมูล</button>
                </div>
            </form>
        </div>

        <!-- Bed Layout -->
        <div class="bg-white rounded-lg shadow-lg p-4 mb-6">
            <h2 class="text-lg font-semibold text-gray-800 mb-4">แผนผังเตียง ICU (9 เตียง)</h2>
            <div class="grid grid-cols-3 gap-4 max-w-2xl mx-auto">
                <!-- Row 1 -->
                <div class="bed-card bg-gray-100 border-2 border-gray-300 rounded-lg p-4 cursor-pointer hover:shadow-md transition-all" data-bed="1">
                    <div class="text-center">
                        <div class="text-lg font-semibold">เตียง 1</div>
                        <div class="bed-status text-sm mt-2">ไม่มีข้อมูล</div>
                        <div class="bed-info text-sm mt-2 text-gray-600"></div>
                    </div>
                </div>
                <div class="bed-card bg-gray-100 border-2 border-gray-300 rounded-lg p-4 cursor-pointer hover:shadow-md transition-all" data-bed="2">
                    <div class="text-center">
                        <div class="text-lg font-semibold">เตียง 2</div>
                        <div class="bed-status text-sm mt-2">ไม่มีข้อมูล</div>
                        <div class="bed-info text-sm mt-2 text-gray-600"></div>
                    </div>
                </div>
                <div class="bed-card bg-gray-100 border-2 border-gray-300 rounded-lg p-4 cursor-pointer hover:shadow-md transition-all" data-bed="3">
                    <div class="text-center">
                        <div class="text-lg font-semibold">เตียง 3</div>
                        <div class="bed-status text-sm mt-2">ไม่มีข้อมูล</div>
                        <div class="bed-info text-sm mt-2 text-gray-600"></div>
                    </div>
                </div>
                <!-- Row 2 -->
                <div class="bed-card bg-gray-100 border-2 border-gray-300 rounded-lg p-4 cursor-pointer hover:shadow-md transition-all" data-bed="4">
                    <div class="text-center">
                        <div class="text-lg font-semibold">เตียง 4</div>
                        <div class="bed-status text-sm mt-2">ไม่มีข้อมูล</div>
                        <div class="bed-info text-sm mt-2 text-gray-600"></div>
                    </div>
                </div>
                <div class="bed-card bg-gray-100 border-2 border-gray-300 rounded-lg p-4 cursor-pointer hover:shadow-md transition-all" data-bed="5">
                    <div class="text-center">
                        <div class="text-lg font-semibold">เตียง 5</div>
                        <div class="bed-status text-sm mt-2">ไม่มีข้อมูล</div>
                        <div class="bed-info text-sm mt-2 text-gray-600"></div>
                    </div>
                </div>
                <div class="bed-card bg-gray-100 border-2 border-gray-300 rounded-lg p-4 cursor-pointer hover:shadow-md transition-all" data-bed="6">
                    <div class="text-center">
                        <div class="text-lg font-semibold">เตียง 6</div>
                        <div class="bed-status text-sm mt-2">ไม่มีข้อมูล</div>
                        <div class="bed-info text-sm mt-2 text-gray-600"></div>
                    </div>
                </div>
                <!-- Row 3 -->
                <div class="bed-card bg-gray-100 border-2 border-gray-300 rounded-lg p-4 cursor-pointer hover:shadow-md transition-all" data-bed="7">
                    <div class="text-center">
                        <div class="text-lg font-semibold">เตียง 7</div>
                        <div class="bed-status text-sm mt-2">ไม่มีข้อมูล</div>
                        <div class="bed-info text-sm mt-2 text-gray-600"></div>
                    </div>
                </div>
                <div class="bed-card bg-gray-100 border-2 border-gray-300 rounded-lg p-4 cursor-pointer hover:shadow-md transition-all" data-bed="8">
                    <div class="text-center">
                        <div class="text-lg font-semibold">เตียง 8</div>
                        <div class="bed-status text-sm mt-2">ไม่มีข้อมูล</div>
                        <div class="bed-info text-sm mt-2 text-gray-600"></div>
                    </div>
                </div>
                <div class="bed-card bg-gray-100 border-2 border-gray-300 rounded-lg p-4 cursor-pointer hover:shadow-md transition-all" data-bed="9">
                    <div class="text-center">
                        <div class="text-lg font-semibold">เตียง 9</div>
                        <div class="bed-status text-sm mt-2">ไม่มีข้อมูล</div>
                        <div class="bed-info text-sm mt-2 text-gray-600"></div>
                    </div>
                </div>
            </div>
            
            <!-- Legend -->
            <div class="mt-4 flex flex-col sm:flex-row justify-center space-y-2 sm:space-y-0 sm:space-x-4 text-xs">
                <div class="flex items-center justify-center">
                    <div class="w-3 h-3 bg-green-400 rounded mr-1"></div>
                    <span>ความเสี่ยงต่ำ (18-23)</span>
                </div>
                <div class="flex items-center justify-center">
                    <div class="w-3 h-3 bg-yellow-400 rounded mr-1"></div>
                    <span>ความเสี่ยงสูง (≤17)</span>
                </div>
                <div class="flex items-center justify-center">
                    <div class="w-3 h-3 bg-red-400 rounded mr-1"></div>
                    <span>มีแผลกดทับ</span>
                </div>
            </div>
        </div>



        <!-- Statistics Dashboard -->
        <div class="bg-white rounded-lg shadow-lg p-6 mb-6">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-semibold text-gray-800 flex items-center">
                    <svg class="w-6 h-6 mr-2 text-teal-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path>
                    </svg>
                    สถิติและรายงาน
                </h2>
                <div class="flex space-x-2">
                    <button id="viewRecordsBtn" class="px-4 py-2 bg-green-600 text-white rounded-md hover:bg-green-700 transition-colors">
                        <svg class="w-4 h-4 inline mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                        </svg>
                        ดูประวัติการบันทึก
                    </button>
                    <button id="exportDataBtn" class="px-4 py-2 bg-purple-600 text-white rounded-md hover:bg-purple-700 transition-colors">
                        <svg class="w-4 h-4 inline mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                        </svg>
                        ส่งออกข้อมูล
                    </button>
                </div>
            </div>
            
            <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                <div class="bg-teal-50 rounded-lg p-4 text-center shadow-sm">
                    <div class="text-2xl font-bold text-teal-600" id="totalPatients">0</div>
                    <div class="text-sm text-gray-600">ผู้ป่วยทั้งหมด</div>
                </div>
                <div class="bg-red-50 rounded-lg p-4 text-center">
                    <div class="text-2xl font-bold text-red-600" id="patientsWithUlcers">0</div>
                    <div class="text-sm text-gray-600">มีแผลกดทับ</div>
                </div>
                <div class="bg-yellow-50 rounded-lg p-4 text-center">
                    <div class="text-2xl font-bold text-yellow-600" id="highRiskPatients">0</div>
                    <div class="text-sm text-gray-600">ความเสี่ยงสูง</div>
                </div>
                <div class="bg-green-50 rounded-lg p-4 text-center">
                    <div class="text-2xl font-bold text-green-600" id="lowRiskPatients">0</div>
                    <div class="text-sm text-gray-600">ความเสี่ยงต่ำ</div>
                </div>
            </div>
            
            <div class="mt-4 grid grid-cols-1 md:grid-cols-2 gap-4">
                <div class="bg-gray-50 rounded-lg p-4">
                    <h3 class="font-semibold text-gray-800 mb-2">อัตราการเกิดแผลกดทับ</h3>
                    <div class="text-3xl font-bold text-red-600" id="ulcerRate">0%</div>
                    <div class="text-sm text-gray-600">จากผู้ป่วยทั้งหมด</div>
                </div>
                <div class="bg-gray-50 rounded-lg p-4">
                    <h3 class="font-semibold text-gray-800 mb-2">คะแนน Braden เฉลี่ย</h3>
                    <div class="text-3xl font-bold text-teal-600" id="avgBradenScore">0</div>
                    <div class="text-sm text-gray-600">คะแนนเฉลี่ยของผู้ป่วยทั้งหมด</div>
                </div>
            </div>
        </div>

        <!-- Care Guidelines -->
        <div id="careGuidelines" class="bg-white rounded-lg shadow-lg p-6 mt-6 hidden">
            <h2 class="text-xl font-semibold text-gray-800 mb-4">แนวทางการพยาบาล</h2>
            <div id="guidelinesContent"></div>
        </div>
    </div>

    <!-- Modal for bed details -->
    <div id="bedModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
        <div class="bg-white rounded-lg p-6 max-w-md w-full mx-4">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-lg font-semibold" id="modalTitle">รายละเอียดเตียง</h3>
                <button id="closeModal" class="text-gray-500 hover:text-gray-700">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                    </svg>
                </button>
            </div>
            <div id="modalContent"></div>
        </div>
    </div>

    <!-- Modal for records history -->
    <div id="recordsModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
        <div class="bg-white rounded-lg p-6 max-w-4xl w-full mx-4 max-h-[90vh] overflow-y-auto">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-xl font-semibold text-gray-800">ประวัติการบันทึกข้อมูล</h3>
                <button id="closeRecordsModal" class="text-gray-500 hover:text-gray-700">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                    </svg>
                </button>
            </div>
            <div id="recordsContent">
                <div class="text-center text-gray-500 py-8">ไม่มีข้อมูลการบันทึก</div>
            </div>
        </div>
    </div>

    <script>
        // Data storage
        let bedData = {};
        let patientData = {}; // เก็บข้อมูลผู้ป่วยตาม HN
        let recordsHistory = []; // เก็บประวัติการบันทึกทั้งหมด

        // Set default date to today
        document.getElementById('recordDate').value = new Date().toISOString().split('T')[0];
        document.getElementById('admissionDate').value = new Date().toISOString().split('T')[0];

        // Auto-fill patient data when HN is entered
        document.getElementById('hn').addEventListener('blur', function() {
            const hn = this.value.trim();
            if (hn && patientData[hn]) {
                const patient = patientData[hn];
                document.getElementById('age').value = patient.age;
                document.getElementById('admissionDate').value = patient.admissionDate;
                document.getElementById('admissionSource').value = patient.admissionSource;
                document.getElementById('admissionDetails').value = patient.admissionDetails || '';
                document.getElementById('admissionWoundStatus').value = patient.admissionWoundStatus || '';
                
                // ซ่อนส่วนข้อมูลการรับสำหรับผู้ป่วยเดิม
                hideAdmissionSection();
                
                // แสดงข้อความแจ้งเตือน
                showPatientFoundMessage(patient);
            } else {
                // แสดงส่วนข้อมูลการรับสำหรับผู้ป่วยใหม่
                showAdmissionSection();
            }
        });

        // Show/Hide admission section functions
        function hideAdmissionSection() {
            const admissionSection = document.querySelector('.bg-blue-50');
            if (admissionSection) {
                admissionSection.style.display = 'none';
            }
        }

        function showAdmissionSection() {
            const admissionSection = document.querySelector('.bg-blue-50');
            if (admissionSection) {
                admissionSection.style.display = 'block';
            }
        }

        // Show patient found message
        function showPatientFoundMessage(patient) {
            const existingAlert = document.getElementById('patientFoundAlert');
            if (existingAlert) {
                existingAlert.remove();
            }

            const alert = document.createElement('div');
            alert.id = 'patientFoundAlert';
            alert.className = 'bg-blue-100 border border-blue-400 text-blue-700 px-4 py-3 rounded mb-4';
            alert.innerHTML = `
                <div class="flex items-center">
                    <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd"></path>
                    </svg>
                    <span><strong>พบข้อมูลผู้ป่วย HN ${patient.hn}</strong> - ประเมิน Braden Score ใหม่ได้เลย (ข้อมูลการรับถูกซ่อนไว้)</span>
                </div>
            `;
            
            const form = document.getElementById('assessmentForm');
            form.insertBefore(alert, form.firstChild);
            
            // Remove alert after 5 seconds
            setTimeout(() => {
                if (alert.parentNode) {
                    alert.remove();
                }
            }, 5000);
        }

        // Update statistics
        function updateStatistics() {
            const totalPatients = Object.keys(bedData).length;
            const patientsWithUlcers = Object.values(bedData).filter(data => data.ulcerStatus !== 'none').length;
            const highRiskPatients = Object.values(bedData).filter(data => data.bradenScore <= 17).length;
            const lowRiskPatients = totalPatients - highRiskPatients;
            
            const ulcerRate = totalPatients > 0 ? ((patientsWithUlcers / totalPatients) * 100).toFixed(1) : 0;
            const avgBradenScore = totalPatients > 0 ? 
                (Object.values(bedData).reduce((sum, data) => sum + data.bradenScore, 0) / totalPatients).toFixed(1) : 0;

            document.getElementById('totalPatients').textContent = totalPatients;
            document.getElementById('patientsWithUlcers').textContent = patientsWithUlcers;
            document.getElementById('highRiskPatients').textContent = highRiskPatients;
            document.getElementById('lowRiskPatients').textContent = lowRiskPatients;
            document.getElementById('ulcerRate').textContent = ulcerRate + '%';
            document.getElementById('avgBradenScore').textContent = avgBradenScore;
        }

        // Care guidelines
        const careGuidelines = {
            prevention: {
                title: "การป้องกันแผลกดทับ (Braden Score ≤ 17)",
                guidelines: [
                    "เปลี่ยนท่านอนทุก 2 ชั่วโมง",
                    "ใช้ที่นอนลดแรงกด (pressure-relieving mattress)",
                    "ตรวจสอบผิวหนังทุกวัน",
                    "รักษาผิวหนังให้สะอาดและแห้ง",
                    "ป้องกันการเสียดสีและแรงเฉือน",
                    "ให้อาหารที่มีโปรตีนเพียงพอ",
                    "ส่งเสริมการเคลื่อนไหวตามความสามารถ"
                ]
            },
            stage1: {
                title: "การดูแลแผลกดทับ Stage 1",
                guidelines: [
                    "หลีกเลี่ยงแรงกดบริเวณแผล",
                    "เปลี่ยนท่านอนทุก 1-2 ชั่วโมง",
                    "ทำความสะอาดด้วยน้ำเกลือ",
                    "ใช้ moisturizer ป้องกันผิวแห้ง",
                    "ประเมินแผลทุกวัน",
                    "บันทึกขนาดและลักษณะแผล"
                ]
            },
            stage2: {
                title: "การดูแลแผลกดทับ Stage 2",
                guidelines: [
                    "ทำความสะอาดแผลด้วยน้ำเกลือ",
                    "ใช้ hydrocolloid หรือ foam dressing",
                    "เปลี่ยนผ้าปิดแผลตามความเหมาะสม",
                    "หลีกเลี่ยงแรงกดบริเวณแผล",
                    "ประเมินแผลทุกวัน",
                    "ป้องกันการติดเชื้อ"
                ]
            },
            stage3: {
                title: "การดูแลแผลกดทับ Stage 3",
                guidelines: [
                    "ทำ wound debridement ตามความจำเป็น",
                    "ใช้ alginate หรือ foam dressing",
                    "รักษาสภาพแวดล้อมแผลให้ชื้น",
                    "ป้องกันการติดเชื้อ",
                    "ประเมินแผลทุกวัน",
                    "ปรึกษาแพทย์เฉพาะทาง"
                ]
            },
            stage4: {
                title: "การดูแลแผลกดทับ Stage 4",
                guidelines: [
                    "ปรึกษาแพทย์เฉพาะทางทันที",
                    "ทำ surgical debridement",
                    "ใช้ negative pressure wound therapy",
                    "ป้องกันการติดเชื้ออย่างเข้มงวด",
                    "ประเมินแผลทุกวัน",
                    "พิจารณาการผ่าตัดปิดแผล"
                ]
            }
        };



        // Calculate Braden Score
        function calculateBradenScore() {
            const sensory = parseInt(document.getElementById('sensoryPerception').value) || 0;
            const moisture = parseInt(document.getElementById('moisture').value) || 0;
            const activity = parseInt(document.getElementById('activity').value) || 0;
            const mobility = parseInt(document.getElementById('mobility').value) || 0;
            const nutrition = parseInt(document.getElementById('nutrition').value) || 0;
            const friction = parseInt(document.getElementById('friction').value) || 0;
            
            const total = sensory + moisture + activity + mobility + nutrition + friction;
            
            document.getElementById('totalBradenScore').textContent = total;
            document.getElementById('bradenScore').value = total;
            
            const riskLevelDiv = document.getElementById('riskLevel');
            if (total === 0) {
                riskLevelDiv.textContent = '';
                riskLevelDiv.className = 'text-sm mt-1 font-medium';
            } else if (total <= 9) {
                riskLevelDiv.textContent = 'ความเสี่ยงสูงมาก (Very High Risk)';
                riskLevelDiv.className = 'text-sm mt-1 font-medium text-red-600';
            } else if (total <= 12) {
                riskLevelDiv.textContent = 'ความเสี่ยงสูง (High Risk)';
                riskLevelDiv.className = 'text-sm mt-1 font-medium text-red-500';
            } else if (total <= 14) {
                riskLevelDiv.textContent = 'ความเสี่ยงปานกลาง (Moderate Risk)';
                riskLevelDiv.className = 'text-sm mt-1 font-medium text-orange-500';
            } else if (total <= 17) {
                riskLevelDiv.textContent = 'ความเสี่ยงเล็กน้อย (Mild Risk)';
                riskLevelDiv.className = 'text-sm mt-1 font-medium text-yellow-600';
            } else {
                riskLevelDiv.textContent = 'ความเสี่ยงต่ำ (Low Risk)';
                riskLevelDiv.className = 'text-sm mt-1 font-medium text-green-600';
            }
        }

        // Form handling
        document.getElementById('assessmentForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const hn = document.getElementById('hn').value;
            const bedNumber = document.getElementById('bedNumber').value;
            const recordDate = document.getElementById('recordDate').value;
            const age = document.getElementById('age').value;
            const bradenScore = parseInt(document.getElementById('bradenScore').value);
            const ulcerStatus = document.getElementById('ulcerStatus').value;
            const ulcerLocation = document.getElementById('ulcerLocation').value;
            const admissionDate = document.getElementById('admissionDate').value;
            const admissionSource = document.getElementById('admissionSource').value;
            const admissionDetails = document.getElementById('admissionDetails').value;
            const admissionWoundStatus = document.getElementById('admissionWoundStatus').value;

            if (bradenScore === 0) {
                alert('กรุณาประเมิน Braden Score ให้ครบทุกหัวข้อ');
                return;
            }

            // Store/Update patient data (ข้อมูลพื้นฐานที่ไม่เปลี่ยน)
            if (!patientData[hn]) {
                patientData[hn] = {
                    hn,
                    age,
                    admissionDate,
                    admissionSource,
                    admissionDetails,
                    admissionWoundStatus,
                    firstRecordDate: recordDate
                };
            } else {
                // อัพเดทเฉพาะข้อมูลที่อาจเปลี่ยนแปลง
                patientData[hn].age = age; // อายุอาจเปลี่ยนถ้าข้ามปี
            }

            // Store current assessment data
            const newRecord = {
                hn, age, bradenScore, ulcerStatus, ulcerLocation, recordDate, bedNumber,
                admissionDate, admissionSource, admissionDetails, admissionWoundStatus,
                timestamp: new Date().toLocaleString('th-TH'),
                id: Date.now() // unique ID for each record
            };

            bedData[bedNumber] = newRecord;
            recordsHistory.push(newRecord); // เก็บประวัติ

            // Update bed display
            updateBedDisplay(bedNumber);
            
            // Update statistics
            updateStatistics();
            
            // Show care guidelines
            showCareGuidelines(bradenScore, ulcerStatus);
            
            // Clear form but keep HN for easy re-assessment
            const currentHN = hn;
            document.getElementById('assessmentForm').reset();
            document.getElementById('hn').value = currentHN; // เก็บ HN ไว้
            document.getElementById('recordDate').value = new Date().toISOString().split('T')[0];
            document.getElementById('totalBradenScore').textContent = '0';
            document.getElementById('riskLevel').textContent = '';
            
            // Remove any existing patient found alert
            const existingAlert = document.getElementById('patientFoundAlert');
            if (existingAlert) {
                existingAlert.remove();
            }
            
            alert('บันทึกข้อมูลเรียบร้อยแล้ว');
        });

        // Update bed display
        function updateBedDisplay(bedNumber) {
            const bedCard = document.querySelector(`[data-bed="${bedNumber}"]`);
            const data = bedData[bedNumber];
            const statusDiv = bedCard.querySelector('.bed-status');
            const infoDiv = bedCard.querySelector('.bed-info');

            let bgColor, borderColor, textColor, status;

            if (data.ulcerStatus !== 'none') {
                bgColor = 'bg-red-100';
                borderColor = 'border-red-400';
                textColor = 'text-red-800';
                status = `มีแผลกดทับ ${data.ulcerStatus.toUpperCase()}`;
            } else if (data.bradenScore <= 17) {
                bgColor = 'bg-yellow-100';
                borderColor = 'border-yellow-400';
                textColor = 'text-yellow-800';
                status = 'ความเสี่ยงสูง';
            } else {
                bgColor = 'bg-green-100';
                borderColor = 'border-green-400';
                textColor = 'text-green-800';
                status = 'ความเสี่ยงต่ำ';
            }

            bedCard.className = `bed-card ${bgColor} border-2 ${borderColor} rounded-lg p-4 cursor-pointer hover:shadow-md transition-all`;
            statusDiv.className = `bed-status text-sm mt-2 font-medium ${textColor}`;
            statusDiv.textContent = status;
            // แสดงเฉพาะสภาพแผลเมื่อแรกรับ (ถ้ามี)
            const admissionWoundInfo = data.admissionWoundStatus ? 
                `<div class="text-xs mt-1 text-orange-600">แผลเมื่อรับ: ${data.admissionWoundStatus.substring(0, 30)}${data.admissionWoundStatus.length > 30 ? '...' : ''}</div>` : '';
            
            infoDiv.innerHTML = `
                <div>HN: ${data.hn} | Score: ${data.bradenScore}</div>
                ${admissionWoundInfo}
            `;
        }

        // Show care guidelines
        function showCareGuidelines(bradenScore, ulcerStatus) {
            const guidelinesDiv = document.getElementById('careGuidelines');
            const contentDiv = document.getElementById('guidelinesContent');
            
            let guidelines;
            if (ulcerStatus !== 'none') {
                guidelines = careGuidelines[ulcerStatus] || careGuidelines.stage1;
            } else if (bradenScore <= 17) {
                guidelines = careGuidelines.prevention;
            } else {
                guidelinesDiv.classList.add('hidden');
                return;
            }

            contentDiv.innerHTML = `
                <h3 class="text-lg font-semibold text-gray-800 mb-3">${guidelines.title}</h3>
                <ul class="space-y-2">
                    ${guidelines.guidelines.map(item => `<li class="flex items-start"><span class="text-blue-500 mr-2">•</span><span>${item}</span></li>`).join('')}
                </ul>
            `;
            
            guidelinesDiv.classList.remove('hidden');
        }

        // Bed click handler
        document.querySelectorAll('.bed-card').forEach(card => {
            card.addEventListener('click', function() {
                const bedNumber = this.dataset.bed;
                const data = bedData[bedNumber];
                
                if (data) {
                    showBedModal(bedNumber, data);
                } else {
                    document.getElementById('bedNumber').value = bedNumber;
                    document.getElementById('hn').focus();
                }
            });
        });

        // Show bed modal
        function showBedModal(bedNumber, data) {
            const modal = document.getElementById('bedModal');
            const title = document.getElementById('modalTitle');
            const content = document.getElementById('modalContent');
            
            title.textContent = `รายละเอียดเตียง ${bedNumber}`;
            
            let riskLevel = data.bradenScore <= 17 ? 'ความเสี่ยงสูง' : 'ความเสี่ยงต่ำ';
            let ulcerText = data.ulcerStatus === 'none' ? 'ไม่มีแผลกดทับ' : `มีแผลกดทับ ${data.ulcerStatus.toUpperCase()}`;
            

            
            // Admission information
            let admissionHtml = '';
            if (data.admissionDate || data.admissionSource) {
                const admissionSourceText = data.admissionSource ? getAdmissionSourceText(data.admissionSource) : '';
                const fullAdmissionSource = data.admissionDetails ? `${admissionSourceText} (${data.admissionDetails})` : admissionSourceText;
                
                admissionHtml = `
                    <div class="mt-4 p-3 bg-blue-50 rounded-lg border border-blue-200">
                        <h4 class="font-semibold text-blue-800 mb-2">ข้อมูลการรับผู้ป่วย</h4>
                        ${data.admissionDate ? `<div class="text-sm"><strong>วันที่รับ:</strong> ${new Date(data.admissionDate).toLocaleDateString('th-TH', {year: 'numeric', month: 'long', day: 'numeric'})}</div>` : ''}
                        ${fullAdmissionSource ? `<div class="text-sm"><strong>รับจาก:</strong> ${fullAdmissionSource}</div>` : ''}
                        ${data.admissionWoundStatus ? `<div class="text-sm mt-2"><strong>สภาพแผลเมื่อรับ:</strong><br>${data.admissionWoundStatus}</div>` : ''}
                    </div>
                `;
            }

            content.innerHTML = `
                <div class="space-y-3">
                    <div><strong>HN:</strong> ${data.hn}</div>
                    <div><strong>อายุ:</strong> ${data.age} ปี</div>
                    <div><strong>วันที่บันทึก:</strong> ${new Date(data.recordDate).toLocaleDateString('th-TH', {year: 'numeric', month: 'long', day: 'numeric'})}</div>
                    <div><strong>Braden Score:</strong> ${data.bradenScore} (${riskLevel})</div>
                    <div><strong>สถานะแผล:</strong> ${ulcerText}</div>
                    ${data.ulcerLocation ? `<div><strong>ตำแหน่งแผล:</strong> ${data.ulcerLocation}</div>` : ''}
                    ${admissionHtml}
                    <div><strong>บันทึกเมื่อ:</strong> ${data.timestamp}</div>
                    <div class="pt-3">
                        <button onclick="editBed('${bedNumber}')" class="px-4 py-2 bg-teal-600 text-white rounded-md hover:bg-teal-700 mr-2 shadow-sm">แก้ไข</button>
                        <button onclick="deleteBed('${bedNumber}')" class="px-4 py-2 bg-red-600 text-white rounded-md hover:bg-red-700">ลบข้อมูล</button>
                    </div>
                </div>
            `;
            
            modal.classList.remove('hidden');
            modal.classList.add('flex');
        }

        // Helper function for admission source text conversion
        function getAdmissionSourceText(value) {
            const texts = {
                'new_admission': 'รับใหม่',
                'transfer': 'รับย้าย',
                'refer': 'รับ Refer'
            };
            return texts[value] || value;
        }



        // Edit bed data
        function editBed(bedNumber) {
            const data = bedData[bedNumber];
            document.getElementById('hn').value = data.hn;
            document.getElementById('bedNumber').value = bedNumber;
            document.getElementById('recordDate').value = data.recordDate;
            document.getElementById('age').value = data.age;
            document.getElementById('bradenScore').value = data.bradenScore;
            document.getElementById('ulcerStatus').value = data.ulcerStatus;
            document.getElementById('ulcerLocation').value = data.ulcerLocation || '';
            
            // Load admission data
            document.getElementById('admissionDate').value = data.admissionDate || '';
            document.getElementById('admissionSource').value = data.admissionSource || '';
            document.getElementById('admissionDetails').value = data.admissionDetails || '';
            document.getElementById('admissionWoundStatus').value = data.admissionWoundStatus || '';
            
            // ซ่อนส่วนข้อมูลการรับถ้าเป็นผู้ป่วยเดิม
            if (patientData[data.hn]) {
                hideAdmissionSection();
            } else {
                showAdmissionSection();
            }
            
            document.getElementById('bedModal').classList.add('hidden');
            document.getElementById('bedModal').classList.remove('flex');
        }

        // Delete bed data
        function deleteBed(bedNumber) {
            if (confirm('ต้องการลบข้อมูลเตียงนี้หรือไม่?')) {
                delete bedData[bedNumber];
                
                const bedCard = document.querySelector(`[data-bed="${bedNumber}"]`);
                bedCard.className = 'bed-card bg-gray-100 border-2 border-gray-300 rounded-lg p-4 cursor-pointer hover:shadow-md transition-all';
                bedCard.querySelector('.bed-status').textContent = 'ไม่มีข้อมูล';
                bedCard.querySelector('.bed-status').className = 'bed-status text-sm mt-2';
                bedCard.querySelector('.bed-info').textContent = '';
                
                // Update statistics
                updateStatistics();
                
                document.getElementById('bedModal').classList.add('hidden');
                document.getElementById('bedModal').classList.remove('flex');
            }
        }

        // Modal close handlers
        document.getElementById('closeModal').addEventListener('click', function() {
            document.getElementById('bedModal').classList.add('hidden');
            document.getElementById('bedModal').classList.remove('flex');
        });

        document.getElementById('bedModal').addEventListener('click', function(e) {
            if (e.target === this) {
                this.classList.add('hidden');
                this.classList.remove('flex');
            }
        });

        // Clear assessment only (keep patient data)
        document.getElementById('clearAssessment').addEventListener('click', function() {
            // Clear only Braden Score assessment and wound status
            document.getElementById('sensoryPerception').value = '';
            document.getElementById('moisture').value = '';
            document.getElementById('activity').value = '';
            document.getElementById('mobility').value = '';
            document.getElementById('nutrition').value = '';
            document.getElementById('friction').value = '';
            document.getElementById('ulcerStatus').value = 'none';
            document.getElementById('ulcerLocation').value = '';
            document.getElementById('bedNumber').value = '';
            
            document.getElementById('totalBradenScore').textContent = '0';
            document.getElementById('bradenScore').value = '';
            document.getElementById('riskLevel').textContent = '';
            document.getElementById('careGuidelines').classList.add('hidden');
        });

        // Clear form
        document.getElementById('clearForm').addEventListener('click', function() {
            if (confirm('ต้องการล้างข้อมูลทั้งหมดหรือไม่? (HN จะถูกล้างด้วย)')) {
                document.getElementById('assessmentForm').reset();
                document.getElementById('recordDate').value = new Date().toISOString().split('T')[0];
                document.getElementById('totalBradenScore').textContent = '0';
                document.getElementById('riskLevel').textContent = '';
                document.getElementById('careGuidelines').classList.add('hidden');
                
                // Set default admission date to today
                document.getElementById('admissionDate').value = new Date().toISOString().split('T')[0];
                
                // แสดงส่วนข้อมูลการรับกลับมา
                showAdmissionSection();
                
                // Remove any existing patient found alert
                const existingAlert = document.getElementById('patientFoundAlert');
                if (existingAlert) {
                    existingAlert.remove();
                }
            }
        });

        // View records history
        document.getElementById('viewRecordsBtn').addEventListener('click', function() {
            showRecordsModal();
        });

        // Export data
        document.getElementById('exportDataBtn').addEventListener('click', function() {
            exportToCSV();
        });

        // Show records modal
        function showRecordsModal() {
            const modal = document.getElementById('recordsModal');
            const content = document.getElementById('recordsContent');
            
            if (recordsHistory.length === 0) {
                content.innerHTML = '<div class="text-center text-gray-500 py-8">ไม่มีข้อมูลการบันทึก</div>';
            } else {
                const sortedRecords = recordsHistory.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
                
                content.innerHTML = `
                    <div class="overflow-x-auto">
                        <table class="min-w-full bg-white border border-gray-200">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">วันที่บันทึก</th>
                                    <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">เตียง</th>
                                    <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">HN</th>
                                    <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">วันที่รับ</th>
                                    <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">ประเภทการรับ</th>
                                    <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Braden Score</th>
                                    <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">สถานะแผล</th>
                                    <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">เวลาบันทึก</th>
                                </tr>
                            </thead>
                            <tbody class="divide-y divide-gray-200">
                                ${sortedRecords.map(record => `
                                    <tr class="hover:bg-gray-50">
                                        <td class="px-4 py-2 text-sm">${new Date(record.recordDate).toLocaleDateString('th-TH')}</td>
                                        <td class="px-4 py-2 text-sm">${record.bedNumber}</td>
                                        <td class="px-4 py-2 text-sm font-medium">${record.hn}</td>
                                        <td class="px-4 py-2 text-sm">${record.admissionDate ? new Date(record.admissionDate).toLocaleDateString('th-TH') : '-'}</td>
                                        <td class="px-4 py-2 text-sm">${record.admissionSource ? getAdmissionSourceText(record.admissionSource) : '-'}</td>
                                        <td class="px-4 py-2 text-sm">
                                            <span class="px-2 py-1 text-xs rounded-full ${record.bradenScore <= 17 ? 'bg-red-100 text-red-800' : 'bg-green-100 text-green-800'}">
                                                ${record.bradenScore}
                                            </span>
                                        </td>
                                        <td class="px-4 py-2 text-sm">
                                            <span class="px-2 py-1 text-xs rounded-full ${record.ulcerStatus !== 'none' ? 'bg-red-100 text-red-800' : 'bg-green-100 text-green-800'}">
                                                ${record.ulcerStatus === 'none' ? 'ไม่มีแผล' : record.ulcerStatus.toUpperCase()}
                                            </span>
                                        </td>
                                        <td class="px-4 py-2 text-sm text-gray-500">${record.timestamp}</td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                `;
            }
            
            modal.classList.remove('hidden');
            modal.classList.add('flex');
        }

        // Export to CSV
        function exportToCSV() {
            if (recordsHistory.length === 0) {
                alert('ไม่มีข้อมูลสำหรับส่งออก');
                return;
            }

            const headers = ['วันที่บันทึก', 'เตียง', 'HN', 'อายุ', 'วันที่รับ', 'ประเภทการรับ', 'รายละเอียดแหล่งที่มา', 'สภาพแผลเมื่อรับ', 'Braden Score', 'สถานะแผล', 'ตำแหน่งแผล', 'เวลาบันทึก'];
            
            // Escape CSV values properly
            function escapeCSV(value) {
                if (value === null || value === undefined) return '';
                const str = String(value);
                if (str.includes(',') || str.includes('"') || str.includes('\n')) {
                    return '"' + str.replace(/"/g, '""') + '"';
                }
                return str;
            }
            
            const csvRows = [
                headers.map(escapeCSV).join(','),
                ...recordsHistory.map(record => [
                    new Date(record.recordDate).toLocaleDateString('th-TH'),
                    record.bedNumber,
                    record.hn,
                    record.age,
                    record.admissionDate ? new Date(record.admissionDate).toLocaleDateString('th-TH') : '-',
                    record.admissionSource ? getAdmissionSourceText(record.admissionSource) : '-',
                    record.admissionDetails || '-',
                    record.admissionWoundStatus || '-',
                    record.bradenScore,
                    record.ulcerStatus === 'none' ? 'ไม่มีแผล' : record.ulcerStatus.toUpperCase(),
                    record.ulcerLocation || '-',
                    record.timestamp
                ].map(escapeCSV).join(','))
            ];
            
            const csvContent = csvRows.join('\n');
            const blob = new Blob(['\ufeff' + csvContent], { type: 'text/csv;charset=utf-8;' });
            
            // Create download link
            const link = document.createElement('a');
            if (link.download !== undefined) {
                const url = URL.createObjectURL(blob);
                link.setAttribute('href', url);
                link.setAttribute('download', `ICU_PI_Records_${new Date().toISOString().split('T')[0]}.csv`);
                link.style.visibility = 'hidden';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                URL.revokeObjectURL(url);
                
                alert('ส่งออกข้อมูลเรียบร้อยแล้ว!');
            } else {
                alert('เบราว์เซอร์ไม่รองรับการดาวน์โหลดไฟล์');
            }
        }

        // Close records modal
        document.getElementById('closeRecordsModal').addEventListener('click', function() {
            document.getElementById('recordsModal').classList.add('hidden');
            document.getElementById('recordsModal').classList.remove('flex');
        });

        document.getElementById('recordsModal').addEventListener('click', function(e) {
            if (e.target === this) {
                this.classList.add('hidden');
                this.classList.remove('flex');
            }
        });
    </script>
<script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'96fd690557447dc3',t:'MTc1NTMxMDM4My4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>
